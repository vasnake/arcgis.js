// Generated by CoffeeScript 1.6.3
/*
Mapedit app classes.
Author: vasnake@gmail.com
*/


(function() {
  var vappFactory;

  console.log("meapp enter");

  if (typeof vappFactory !== "undefined" && vappFactory !== null) {
    alert("vappFactory defined already!");
  } else {
    vappFactory = {};
  }

  define(["dojo/_base/declare", "dojo/dom", 'dojo/has', "vs/mpvlib"], function(declare, dom, has, mpvlib) {
    console.log('meapp dojo/define. define app classes');
    try {
      vslib.log('try vslib');
    } catch (_error) {
      window.vslib = new mpvlib();
    }
    vslib.log('vs.mpvlib declare vappFactory');
    vappFactory = {
      constructor: function(args) {
        vslib.log('vs.meapp constructor');
        return declare.safeMixin(this, args);
      },
      log: function(str, doalert) {
        return vslib.log("vs.meapp." + str, doalert);
      },
      geometryCenter: function(geom) {
        var fig, res;
        this.log("geometryCenter");
        console.debug("geometryCenter. input: ", arguments);
        res = {
          point: null,
          extent: null
        };
        fig = null;
        if (geom.type === 'point') {
          res.point = new esri.geometry.Point(geom);
        }
        if (geom.type === 'polygon') {
          fig = new esri.geometry.Polygon(geom);
        }
        if (geom.type === 'polyline') {
          fig = new esri.geometry.Polyline(geom);
        }
        if (fig !== null) {
          res.extent = fig.getExtent();
          res.point = res.extent.getCenter();
        }
        return res;
      },
      loadFCTable: function(fcUrl, fcName) {
        var _ref;
        if (fcName == null) {
          fcName = 'n/a';
        }
        this.log("loadFCTable");
        console.debug("loadFCTable. fcUrl: ", arguments);
        dojo.byId('fsEndpoint').value = fcUrl;
        if ((_ref = dijit.byId('bottomPaneTableName')) != null) {
          _ref.set("label", "Закрыть таблицу '" + fcName + "'");
        }
        featureEditor.onZoomToCurrentRecord = function(featureInfo) {
          var center, defer;
          console.log("meapp.FCT.onZoomToCurrentRecord. featureInfo, this: ", arguments, this);
          center = vsapp.geometryCenter(featureInfo.feature.geometry);
          if (center.extent !== null) {
            defer = map.setExtent(center.extent, true);
          }
          if (center.extent === null) {
            defer = map.centerAndZoom(center.point, map.getMaxScale());
          }
          return defer.then(function() {
            return console.log("onZoomToCurrentRecord complete", arguments, center);
          });
        };
        return showAttribsTable();
      },
      createEditorMenu: function() {
        return require(["dijit/Menu", "dijit/MenuItem", "dijit/CheckedMenuItem", "dijit/MenuSeparator", "dijit/PopupMenuItem", "dojo/domReady!"], dojo.hitch(this, function(Menu, MenuItem, CheckedMenuItem, MenuSeparator, PopupMenuItem) {
          var idx, menuButton, sd, self, subdata, tabsmenu, _i, _len;
          this.log("createEditorMenu");
          subdata = [
            {
              label: "Отключающие устройства",
              url: "http://cgis.allgis.org/arcgis/rest/services/edit_Газовая_сеть/FeatureServer/0"
            }, {
              label: "СКЗ",
              url: "http://cgis.allgis.org/arcgis/rest/services/edit_Газовая_сеть/FeatureServer/1"
            }, {
              label: "Газопроводы",
              url: "http://cgis.allgis.org/arcgis/rest/services/edit_Газовая_сеть/FeatureServer/2"
            }, {
              label: "ГРП",
              url: "http://cgis.allgis.org/arcgis/rest/services/edit_Газовая_сеть/FeatureServer/3"
            }
          ];
          self = this;
          tabsmenu = new Menu;
          for (idx = _i = 0, _len = subdata.length; _i < _len; idx = ++_i) {
            sd = subdata[idx];
            tabsmenu.addChild(new MenuItem({
              label: sd.label,
              iconClass: "dijitFolderOpened",
              fClassUrl: sd.url,
              onClick: function() {
                console.log("editor menu, table menuitem onclick. ", arguments);
                return self.loadFCTable(this.fClassUrl, this.label);
              }
            }));
          }
          menuButton = new dijit.form.DropDownButton({
            label: "Атрибутика",
            id: 'editorDropDownButton',
            title: "Таблицы",
            dropDown: tabsmenu,
            iconClass: "dijitFolderOpened"
          });
          menuButton.startup;
          return dojo.byId('webmap-toolbar-left').appendChild(menuButton.domNode);
        }));
      }
    };
    vslib.log('meapp dojo/declare vs.meapp');
    return declare("vs.meapp", null, vappFactory);
  });

  console.log("meapp leave");

}).call(this);

/*
//@ sourceMappingURL=meapp.map
*/
